<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin</title>

  <!-- Inter font + Bootstrap + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/images/logo-removebg-preview.png" />
  <style>
    :root{
      --bg:#06060a; --card:#0f1720; --accent:#7c4dff;
      --muted:#cbd5e1; --text:#eef6ff; --muted-2:#94a3b8;
      --row-bg: rgba(255,255,255,0.02); --row-hover: rgba(255,255,255,0.05);
      --border: rgba(255,255,255,0.08);
    }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg), #031021);
      color:var(--text);font-family:Inter,system-ui,"Segoe UI";}
    .container-xl { padding:28px 20px; max-width:1200px; }
    .card { background: var(--card); border: 1px solid rgba(255,255,255,0.04); border-radius: 12px; color: var(--text);}
    .table-users { width:100%; border-collapse:separate; border-spacing:0 10px;}
    .table-users thead th { color: var(--muted-2); font-weight:600; text-transform:uppercase; font-size:0.78rem; padding:10px 12px;}
    .table-users tbody tr { background: var(--row-bg); border-radius: 10px; transition:background 0.15s ease, transform 0.15s ease;}
    .table-users tbody tr:hover { background: var(--row-hover); transform: translateY(-2px);}
    .table-users td { padding:14px 12px; color:var(--text); vertical-align:middle; border:none;}
    .table-users tbody tr td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px;}
    .table-users tbody tr td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px;}
    .table-users td .btn { margin-bottom: 4px; width: 80px; text-align: left;}
    .small-muted { color: var(--muted); font-size:0.92rem; }
    .btn-outline-light { border-color: rgba(255,255,255,0.06); color:var(--text);}
    .btn-outline-light:hover { background: rgba(255,255,255,0.02);}
    .btn-danger { background: linear-gradient(180deg,#ef4444,#dc2626); border:none; color:#fff; }
    .btn-danger:hover { filter:brightness(1.05);}
    .badge-role-user { background:#6b7280; color:#fff; padding:4px 8px; border-radius:999px; font-weight:600; font-size:0.82rem; }
    .badge-role-admin { background:#10b981; color:#032; padding:4px 8px; border-radius:999px; font-weight:700; font-size:0.82rem; }
    .modal-content { background: var(--card); color:var(--text); border:none; }
    label { color: var(--muted); }
  </style>
</head>
<body>
  <div class="container-xl">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 style="margin:0">Admin — Manage Users</h3>
        <div class="small-muted">Chỉ admin mới được truy cập trang này.</div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-light" href="dashboard.html"><i class="bi bi-shop"></i> Back to Store</a>
        <a class="btn btn-sm btn-primary" href="index.html"><i class="bi bi-box-arrow-right"></i> Sign out</a>
      </div>
    </div>

    <div class="card p-3 mb-4 d-flex justify-content-between align-items-center">
      <strong>Users</strong>
      <button id="btnAddUser" class="btn btn-sm btn-outline-light"><i class="bi bi-plus-lg"></i> Add user</button>
    </div>

    <div class="card p-3">
      <div class="table-responsive">
        <table id="usersTable" class="table table-dark table-borderless align-middle mb-0 table-users">
          <thead>
            <tr>
              <th style="width:50px">#</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Last login</th>
              <th style="width:170px">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal: Edit/Create User -->
  <div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 id="userModalTitle" class="modal-title">Edit user</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="userForm">
        <div class="modal-body">
          <input type="hidden" id="userId">
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input id="usernameInput" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input id="emailInput" type="email" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select id="roleSelect" class="form-select">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">New password (optional)</label>
            <input id="passwordInput" type="password" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" id="saveUserBtn" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div></div>
  </div>

  <!-- Modal: Confirm Delete -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-body">
        <h5 class="mb-3">Confirm delete</h5>
        <p class="small-muted">Bạn có chắc chắn muốn xóa user <strong id="delUsername"></strong>?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
        <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
      </div>
    </div></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const userModal = new bootstrap.Modal(document.getElementById('userModal'));
  const confirmModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
  const usersTable = document.querySelector('#usersTable tbody');

  // Form inputs
  const inputId = document.getElementById('userId');
  const inputUsername = document.getElementById('usernameInput');
  const inputEmail = document.getElementById('emailInput');
  const inputRole = document.getElementById('roleSelect');
  const inputPassword = document.getElementById('passwordInput');
  let rowToDelete = null;

  // Escape HTML helper
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
  }

  // Load users from API
  async function loadUsers(){
    try {
      const res = await fetch("/admin/users", {
        headers: { Authorization:"Bearer " + localStorage.getItem("token") }
      });
      if(!res.ok){
        alert("Unauthorized or not admin!");
        window.location.href = "/auth/login";
        return;
      }
      const data = await res.json();
      renderUsers(data);
    } catch(e){
      console.error("Load users error:", e);
    }
  }

  // Render user rows
  function renderUsers(users){
    usersTable.innerHTML="";
    users.forEach((u,i)=>{
      const tr=document.createElement("tr");
      tr.setAttribute("data-id",u._id);
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="td-username">${escapeHtml(u.username)}</td>
        <td class="td-email">${escapeHtml(u.email)}</td>
        <td class="td-role">
          <span class="${u.role==='admin'?'badge badge-role-admin':'badge badge-role-user'}">
            ${u.role}
          </span>
        </td>
        <td class="td-lastlogin small-muted">${u.lastLogin||"-"}</td>
        <td>
          <div class="d-flex flex-column">
            <button class="btn btn-sm btn-outline-light btn-view mb-1"><i class="bi bi-eye"></i> View</button>
            <button class="btn btn-sm btn-outline-light btn-edit mb-1"><i class="bi bi-pencil"></i> Edit</button>
            <button class="btn btn-sm btn-danger btn-delete"><i class="bi bi-trash"></i> Delete</button>
          </div>
        </td>`;
      usersTable.appendChild(tr);
    });
  }

  // Handle clicks in table
  usersTable.addEventListener('click', ev=>{
    const tr=ev.target.closest('tr'); if(!tr) return;
    const id=tr.getAttribute("data-id");

    if(ev.target.closest('.btn-edit')) openEditModal(tr);
    if(ev.target.closest('.btn-view')) alert("Implement /admin/users/"+id+" profile view");
    if(ev.target.closest('.btn-delete')){
      rowToDelete=tr;
      document.getElementById('delUsername').textContent=tr.querySelector('.td-username').textContent;
      confirmModal.show();
    }
  });

  // Open edit modal
  function openEditModal(tr){
    inputId.value=tr.getAttribute("data-id");
    inputUsername.value=tr.querySelector('.td-username').textContent.trim();
    inputEmail.value=tr.querySelector('.td-email').textContent.trim();
    inputRole.value=tr.querySelector('.td-role span').textContent.trim();
    inputPassword.value="";
    document.getElementById('userModalTitle').textContent="Edit user";
    userModal.show();
  }

  // Open add modal
  document.getElementById('btnAddUser').addEventListener('click',()=>{
    inputId.value="";
    inputUsername.value="";
    inputEmail.value="";
    inputRole.value="user";
    inputPassword.value="";
    document.getElementById('userModalTitle').textContent="Create new user";
    userModal.show();
  });

  // Save user (create or update)
  document.getElementById('userForm').addEventListener('submit',async e=>{
    e.preventDefault();
    const id=inputId.value;
    const body={
      username: inputUsername.value,
      email: inputEmail.value,
      role: inputRole.value
    };
    if(inputPassword.value) body.password=inputPassword.value;

    const method=id?"PUT":"POST";
    const url=id?`/admin/users/${id}`:"/admin/users";

    try{
      const res = await fetch(url,{
        method,
        headers:{
          "Content-Type":"application/json",
          Authorization:"Bearer " + localStorage.getItem("token")
        },
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error("Save failed");
      userModal.hide();
      loadUsers();
    }catch(err){console.error("Save user error:",err);}
  });

  // Confirm delete
  document.getElementById('confirmDeleteBtn').addEventListener('click',async ()=>{
    if(!rowToDelete) return;
    const id=rowToDelete.getAttribute("data-id");
    try{
      const res=await fetch(`/admin/users/${id}`,{
        method:"DELETE",
        headers:{Authorization:"Bearer " + localStorage.getItem("token")}
      });
      if(!res.ok) throw new Error("Delete failed");
      confirmModal.hide();
      loadUsers();
    }catch(e){console.error("Delete error:",e);}
  });

  document.addEventListener("DOMContentLoaded", loadUsers);
</script>

</body>
</html>
