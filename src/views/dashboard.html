<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>

  <!-- Inter font + Bootstrap + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/images/logo-removebg-preview.png" />

<style>
  :root{
    --bg:#06060a;
    --card:#0f1720;
    --accent:#7c4dff;
    --muted:#cbd5e1;
  }
  body{
    background:linear-gradient(180deg,var(--bg), #041021);
    color:#f8fafc;
    font-family:Inter,system-ui;
  }
  .navbar-dark {
    background:linear-gradient(90deg, rgba(124,77,255,0.08), rgba(110,197,255,0.03));
  }
  .card-product{
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border:1px solid rgba(255,255,255,0.08);
    border-radius:12px;
    color:#f1f5f9;
  }
  .price{ font-weight:700; color:#fff; }
  .muted{ color:var(--muted) }
  .container-xl{ padding-top:2.25rem; padding-bottom:2.25rem; }
  .hero{
    padding:1.25rem;
    border-radius:12px;
    background:rgba(255,255,255,0.04);
    margin-bottom:1.25rem;
    color:#f1f5f9;
  }
  .badge-balance{
    background: rgba(124,77,255,0.18);
    border: 1px solid rgba(124,77,255,0.45);
    color:#f8faff;
    border-radius: 999px;
    padding: .35rem .65rem;
    font-weight: 700;
    display:inline-flex;
    align-items:center;
    gap:.4rem;
  }

  /* small status under btns */
  .card-status { font-size:0.86rem; color:var(--muted); margin-top:6px; min-height:18px; }

  /* make buy button fixed width matching view button's visual weight */
  .btn-buy { min-width:68px; }

</style>
</head>
<body>
  <!-- Top navbar -->
  <nav class="navbar navbar-dark navbar-expand-lg px-3">
    <a class="navbar-brand d-flex align-items-center" href="dashboard.html">
       <img src="/images/logo.png" alt="Logo" style="width:36px;height:36px;border-radius:8px;margin-right:8px">
       <span style="font-weight:700">VHU Store</span>
    </a>

    <div class="ms-auto d-flex align-items-center gap-2">
      <span class="badge-balance">
        <i class="bi bi-coin"></i>
        Balance: <span id="balanceValue">10</span>
      </span>
      <a class="btn btn-sm btn-outline-light" href="orders.html"><i class="bi bi-basket3"></i> Orders</a>
      <a class="btn btn-sm btn-outline-light" href="users.html"><i class="bi bi-people"></i> Users</a>
      <a id="btnLogout" class="btn btn-sm btn-primary" href="#">Sign out</a>
    </div>
  </nav>

  <div class="container-xl">
    <div class="hero d-flex justify-content-between align-items-center">
      <div>
        <h3 style="margin:0">Dashboard Store</h3>
        <div class="muted">Showing product list from database.</div>
      </div>
      <div class="text-end">
        <div class="muted">Total products</div>
        <div id="totalProducts" style="font-weight:700;font-size:1.25rem">0</div>
      </div>
    </div>

    <!-- Product grid -->
    <div class="row g-3" id="productsContainer">
      <!-- Render products here -->
    </div>
  </div>

  <!-- Optional JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  async function checkAuthAndLoad() {
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "/auth/login";
      return;
    }

    try {
      const check = await fetch("/auth/me", {
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!check.ok) {
        localStorage.removeItem("token");
        window.location.href = "/auth/login";
        return;
      }

      await loadProducts(token);
    } catch (err) {
      console.error("Auth check error:", err);
      window.location.href = "/auth/login";
    }
  }

  async function loadProducts(token){
    try {
      const res = await fetch("/api/products", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok) {
        console.error("Failed to fetch products:", res.status);
        return;
      }
      const data = await res.json();

      document.getElementById("totalProducts").textContent = data.total;

      const container = document.getElementById("productsContainer");
      container.innerHTML = "";

      data.products.forEach(p => {
        const image = p.imageUrl || ("https://picsum.photos/seed/" + p._id + "/480/320");
        const title = escapeHtml(p.title || ("Product " + p._id));
        const desc = escapeHtml(p.description || "No description");
        const price = typeof p.price === "number" ? p.price : 0;
        const stock = escapeHtml(p.stock || "Unknown");

        const col = document.createElement("div");
        col.className = "col-12 col-sm-6 col-md-4 col-lg-3";
        col.innerHTML = `
          <div class="card card-product p-3 h-100" data-product-id="${p._id}" data-is-flag="${p.isFlag ? "1" : "0"}">
            <img src="${image}" class="img-fluid rounded mb-3" alt="${title}">
            <h6 style="margin-bottom:0.25rem">${title}</h6>
            <div class="muted small mb-2">${desc}</div>
            <div class="d-flex justify-content-between align-items-center mt-auto">
              <div>
                <div class="price">â‚«${price.toLocaleString()}</div>
                <div class="small muted">${stock}</div>
              </div>
              <div class="d-flex align-items-center">
                <a class="btn btn-sm btn-outline-light me-2 btn-view" 
                   href="product-view.html?url=${encodeURIComponent(image)}" 
                   title="View product image">
                   <i class="bi bi-eye"></i>
                </a>
                <button class="btn btn-sm btn-primary btn-buy" data-product-id="${p._id}">Buy</button>
              </div>
            </div>
            <div class="card-status" aria-live="polite"></div>
          </div>
        `;
        container.appendChild(col);
      });
    } catch (err) {
      console.error("Error loading products:", err);
    }
  }

  document.getElementById("productsContainer").addEventListener("click", async (ev) => {
    const buyBtn = ev.target.closest(".btn-buy");
    if (!buyBtn) return;

    const productId = buyBtn.getAttribute("data-product-id");
    if (!productId) return;

    const card = buyBtn.closest(".card");
    const statusEl = card.querySelector(".card-status");

    buyBtn.disabled = true;
    const prevHtml = buyBtn.innerHTML;
    buyBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

    statusEl.textContent = "Processing order...";

    const token = localStorage.getItem("token");
    if (!token) {
      statusEl.textContent = "Not authenticated.";
      buyBtn.disabled = false;
      buyBtn.innerHTML = prevHtml;
      return;
    }

    try {
      const res = await fetch("/orders", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ items: [{ productId, quantity: 1 }] })
      });

      const result = await res.json();

      if (!res.ok) {
        statusEl.textContent = result.message || "Order failed.";
        console.warn("Order failed:", result);
      } else {
        statusEl.textContent = result.message || "Order successful.";

        if (result.flag) {
          console.info("FLAG (server returned):", result.flag);
        }

        if (result.orderId) {
          statusEl.textContent += " Order ID: " + result.orderId;
        }
      }
    } catch (err) {
      console.error("Create order error:", err);
      statusEl.textContent = "Network or server error.";
    } finally {
      buyBtn.disabled = false;
      buyBtn.innerHTML = prevHtml;
    }
  });

  document.getElementById("btnLogout").addEventListener("click", () => {
    localStorage.removeItem("token");
    window.location.href = "/auth/login";
  });

  function escapeHtml(s) {
    if (!s) return "";
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  checkAuthAndLoad();
</script>

</body>
</html>
