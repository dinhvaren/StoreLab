{{> header}}

<style>
  :root{
    --bg:#06060a;
    --card:#0f1720;
    --accent:#7c4dff;
    --muted:#cbd5e1;
    --text:#eef6ff;
    --muted-2:#94a3b8;
    --row-bg: rgba(255,255,255,0.02);
    --row-hover: rgba(255,255,255,0.05);
    --border: rgba(255,255,255,0.08);
  }

  html,body{height:100%}
  body{
    margin:0;
    background:linear-gradient(180deg,var(--bg), #031021);
    color:var(--text);
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .container-xl { padding:28px 20px; max-width:1200px; }

  .card {
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.04);
    border-radius: 12px;
    color: var(--text);
  }

  .table-users {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
  }
  .table-users thead th {
    color: var(--muted-2);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.78rem;
    padding: 10px 12px;
    background: transparent;
    border: none;
  }
  .table-users tbody tr {
    background: var(--row-bg);
    border-radius: 10px;
    transition: background 0.15s ease, transform 0.15s ease;
  }
  .table-users tbody tr:hover {
    background: var(--row-hover);
    transform: translateY(-2px);
  }
  .table-users td {
    padding: 14px 12px;
    color: var(--text);
    vertical-align: middle;
    border: none;
  }
  .table-users tbody tr td:first-child {
    border-top-left-radius: 10px;
    border-bottom-left-radius: 10px;
  }
  .table-users tbody tr td:last-child {
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
  }

  .table-users td .btn {
    margin-bottom: 4px;
    width: 80px;
    text-align: left;
  }

  .small-muted { color: var(--muted); font-size:0.92rem; }

  .btn-outline-light { border-color: rgba(255,255,255,0.06); color:var(--text); background:transparent; }
  .btn-outline-light:hover { background: rgba(255,255,255,0.02); }
  .btn-danger { background: linear-gradient(180deg,#ef4444,#dc2626); border:none; color:#fff; }
  .btn-danger:hover { filter:brightness(1.05); }

  .badge-role-user { background:#6b7280; color:#fff; padding:4px 8px; border-radius:999px; font-weight:600; font-size:0.82rem; }
  .badge-role-admin { background:#10b981; color:#032; padding:4px 8px; border-radius:999px; font-weight:700; font-size:0.82rem; }

  .modal-content { background: var(--card); color:var(--text); border:none; }
  label { color: var(--muted); }

  @media (max-width: 720px) {
    .table-users thead th { display:none; }
    .table-users tbody td { display:block; width:100%; padding:10px 12px; }
    .table-users tbody tr { margin-bottom:10px; display:block; }
    .container-xl { padding-left:12px; padding-right:12px; }
  }
</style>

<div class="container-xl">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 style="margin:0">Admin</h3>
    </div>
  </div>

  <!-- Controls -->
  <div class="card p-3 mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <strong>Manage Users</strong>
      </div>
      <div>
        <button id="btnAddUser" class="btn btn-sm btn-outline-light"><i class="bi bi-plus-lg"></i> Add user</button>
      </div>
    </div>
  </div>

  <!-- Users table -->
  <div class="card p-3">
    <div class="table-responsive">
      <table id="usersTable" class="table table-dark table-borderless align-middle mb-0">
        <thead class="small-muted">
          <tr>
            <th style="width:50px">#</th>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Balance</th>
            <th>Last login</th>
            <th style="width:170px">Actions</th>
          </tr>
        </thead>
        <tbody>
          {{#each users}}
            <tr data-id="{{this._id}}">
              <td>{{@index}}</td>
              <td class="td-username">{{this.username}}</td>
              <td class="td-email">{{this.email}}</td>
              <td class="td-role">
                {{#if (eq this.role "admin")}}
                  <span class="badge badge-role-admin">admin</span>
                {{else}}
                  <span class="badge badge-role-user">user</span>
                {{/if}}
              </td>
              <td>₫{{this.balance}}</td>
              <td class="td-lastlogin small-muted">{{formatDate this.lastLogin}}</td>
              <td>
                <div class="d-flex flex-column">
                  <button class="btn btn-sm btn-outline-light btn-view mb-1" title="View profile">
                    <i class="bi bi-eye"></i> View
                  </button>
                  <button class="btn btn-sm btn-outline-light btn-edit mb-1">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-danger btn-delete">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </div>
              </td>
            </tr>
          {{else}}
            <tr><td colspan="7" class="text-center small-muted">Không có người dùng nào trong hệ thống.</td></tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>
</div>

  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="userModalTitle" class="modal-title">Edit user</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="userForm">
          <div class="modal-body">
            <!-- Hidden field: id (for edit) -->
            <input type="hidden" id="userId">

            <!-- Username -->
            <div class="mb-3">
              <label for="usernameInput" class="form-label">Username</label>
              <input id="usernameInput" class="form-control" required>
              <div class="form-text small-muted">Unique username. Validate on server when integrating.</div>
            </div>

            <!-- Email -->
            <div class="mb-3">
              <label for="emailInput" class="form-label">Email</label>
              <input id="emailInput" type="email" class="form-control" required>
            </div>

            <!-- Role -->
            <div class="mb-3">
              <label for="roleSelect" class="form-label">Role</label>
              <select id="roleSelect" class="form-select">
                <option value="user">user</option>
                <option value="admin">admin</option>
              </select>
              <div class="form-text small-muted">Changing role affects privileges. Server must verify this operation.</div>
            </div>

            <!-- Optional: password reset (client-only demo) -->
            <div class="mb-3">
              <label for="passwordInput" class="form-label">New password (optional)</label>
              <input id="passwordInput" type="password" class="form-control" placeholder="Leave blank to keep existing">
              <div class="form-text small-muted">In real app: send password change request to server (hashed).</div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" id="saveUserBtn" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Confirm delete modal -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">
          <h5 class="mb-3">Confirm delete</h5>
          <p class="small-muted">Bạn có chắc chắn muốn xóa user <strong id="delUsername"></strong>? Hành động này không thể hoàn tác.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>

    const userModalElem = document.getElementById('userModal');
    const userModal = new bootstrap.Modal(userModalElem);
    const confirmModalElem = document.getElementById('confirmDeleteModal');
    const confirmModal = new bootstrap.Modal(confirmModalElem);

    const usersTable = document.getElementById('usersTable').querySelector('tbody');
    const userForm = document.getElementById('userForm');
    const userModalTitle = document.getElementById('userModalTitle');
    const inputId = document.getElementById('userId');
    const inputUsername = document.getElementById('usernameInput');
    const inputEmail = document.getElementById('emailInput');
    const inputRole = document.getElementById('roleSelect');
    const inputPassword = document.getElementById('passwordInput');

    let rowToDelete = null;

    function findRowById(id) {
      return usersTable.querySelector('tr[data-id="' + id + '"]');
    }

    usersTable.addEventListener('click', (ev) => {
      const tr = ev.target.closest('tr');
      if (!tr) return;
      const id = tr.getAttribute('data-id');

      if (ev.target.closest('.btn-edit')) {
        openEditModal(tr);
        return;
      }

      if (ev.target.closest('.btn-view')) {
        const username = tr.querySelector('.td-username').textContent;
        alert('Open profile for ' + username + ' (demo). Implement server route /users/:id to view profile.)');
        return;
      }

      if (ev.target.closest('.btn-delete')) {
        rowToDelete = tr;
        const username = tr.querySelector('.td-username').textContent;
        document.getElementById('delUsername').textContent = username;
        confirmModal.show();
      }
    });

    document.getElementById('btnAddUser').addEventListener('click', () => {
      inputId.value = '';
      inputUsername.value = '';
      inputEmail.value = '';
      inputRole.value = 'user';
      inputPassword.value = '';
      userModalTitle.textContent = 'Create new user';
      userModal.show();
    });

    function openEditModal(tr) {
      inputId.value = tr.getAttribute('data-id');
      inputUsername.value = tr.querySelector('.td-username').textContent.trim();
      inputEmail.value = tr.querySelector('.td-email').textContent.trim();
      const roleBadge = tr.querySelector('.td-role span');
      inputRole.value = roleBadge ? roleBadge.textContent.trim() : 'user';
      inputPassword.value = '';
      userModalTitle.textContent = 'Edit user';
      userModal.show();
    }

    userForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const id = inputId.value;
      const username = inputUsername.value.trim();
      const email = inputEmail.value.trim();
      const role = inputRole.value;
      const pwd = inputPassword.value;

      if (!username || !email) {
        alert('Please fill username and email.');
        return;
      }

      if (id) {
        const tr = findRowById(id);
        if (!tr) {
          alert('Row not found (id=' + id + ').');
          userModal.hide();
          return;
        }
        tr.querySelector('.td-username').textContent = username;
        tr.querySelector('.td-email').textContent = email;
        const roleSpan = tr.querySelector('.td-role span');
        roleSpan.textContent = role;
        if (role === 'admin') {
          roleSpan.className = 'badge badge-role-admin';
        } else {
          roleSpan.className = 'badge badge-role-user';
        }
        userModal.hide();
      } else {
        const newId = Date.now();
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', newId);
        tr.innerHTML = `
          <td></td>
          <td class="td-username">${escapeHtml(username)}</td>
          <td class="td-email">${escapeHtml(email)}</td>
          <td class="td-role"><span class="${role === 'admin' ? 'badge badge-role-admin' : 'badge badge-role-user'}">${role}</span></td>
          <td class="td-lastlogin small-muted">-</td>
          <td>
            <button class="btn btn-sm btn-outline-light btn-view me-1" title="View profile"><i class="bi bi-eye"></i></button>
            <button class="btn btn-sm btn-outline-light btn-edit me-1"><i class="bi bi-pencil"></i> Edit</button>
            <button class="btn btn-sm btn-danger btn-delete"><i class="bi bi-trash"></i> Delete</button>
          </td>
        `;
        usersTable.appendChild(tr);
        renumberRows();
        userModal.hide();
      }
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
      if (!rowToDelete) {
        confirmModal.hide();
        return;
      }
      rowToDelete.remove();
      rowToDelete = null;
      renumberRows();
      confirmModal.hide();
    });

    function renumberRows() {
      const rows = usersTable.querySelectorAll('tr');
      rows.forEach((r, i) => {
        const cell = r.querySelector('td:first-child');
        if (cell) cell.textContent = i + 1;
      });
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    renumberRows();
  </script>