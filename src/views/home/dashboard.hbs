<style>
  :root{
    --bg:#06060a;
    --card:#0f1720;
    --accent:#7c4dff;
    --muted:#cbd5e1;
  }
  body{ background:linear-gradient(180deg,var(--bg), #041021); color:#f8fafc; font-family:Inter,system-ui; }
  .card-product{ background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.08); border-radius:12px; color:#f1f5f9;}
  .price{ font-weight:700; color:#fff;}
  .muted{ color:var(--muted);}
  .hero{ padding:1.25rem; border-radius:12px; background:rgba(255,255,255,0.04); margin-bottom:1.25rem;}
</style>
{{> header}}
<div class="container-xl">
  <div class="hero d-flex justify-content-between align-items-center">
    <div>
      <h3 style="margin:0">Dashboard Store</h3>
      <div class="muted">Showing products from MongoDB (dynamic render).</div>
    </div>
    <div class="text-end">
      <div class="muted">Total products</div>
      <div style="font-weight:700;font-size:1.25rem">{{products.length}}</div>
    </div>
  </div>

  <div class="row g-3">
    {{#each products}}
      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <div class="card card-product p-3 h-100">
          <img src="{{this.imageUrl}}" class="img-fluid rounded mb-3" alt="{{this.title}}">
          <h6 style="margin-bottom:0.25rem">{{this.title}}</h6>
          <div class="muted small mb-2">{{this.description}}</div>

          <div class="d-flex justify-content-between align-items-center mt-auto">
            <div>
              <div class="price">‚Ç´{{formatCurrency this.price}}</div>
              <div class="small muted">{{this.stock}}</div>
            </div>
            <div>
              <a href="/view/product?url={{this.imageUrl}}" class="btn btn-sm btn-outline-light me-1">
                <i class="bi bi-eye"></i>
              </a>
              <button 
              class="btn btn-sm btn-primary btn-buy"
              data-id="{{this._id}}"
              data-flag="{{this.isFlag}}"
              data-value="{{this.flagValue}}"
              data-title="{{this.title}}">
              Buy
            </button>
            </div>
          </div>
        </div>
      </div>
    {{/each}}
  </div>
</div>
{{> footer}}
<script>
  document.querySelectorAll(".btn-buy").forEach(btn => {
    btn.addEventListener("click", async () => {
      const productId = btn.getAttribute("data-id");
      const title = btn.dataset.title;

      try {
        const res = await fetch(`/buy/${productId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();

        if (data.success) {
          alert(`‚úÖ ${data.message}`);
          if (data.flag) {
            alert(`üéØ FLAG: ${data.flag}`);
            console.log("%cFLAG:", "color:#7c4dff;font-weight:bold;", data.flag);
          }
          location.reload();
        } else {
          alert(`‚ö†Ô∏è ${data.message}`);
        }
      } catch (err) {
        alert("‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu mua h√†ng.");
        console.error(err);
      }
    });
  });
</script>

